{extend name="public/common"}

{block name="style"}
<title>党员之家</title>
<link rel="stylesheet" href="/home/css/company/index.css">
{/block}
{block name="body"}
<div class="tabs">
	<span class="tab active">组织概况</span>
	<span class="tab">数据统计</span>
	<span class="tab">VR</span>
</div>
<div class="lists">
	<!--好案例：good,新成果：new-->
	{volist name="list" id="vo"}
	<a href="{:Url('Company/detail?id='.$vo['id'])}" class="list">
		<img src="{$vo.front_cover|get_cover='path'}" alt="封面图" class="cover">
		<img src="{$vo.image|get_cover='path'}" alt="头像" class="user">
		<div class="title limit">{$vo.title}</div>
	</a>
	{/volist}
</div>
<div class="tip"></div>
<div class="loading hidden">
	<div class="typing_loader"></div>
</div>
{/block}

{block name="script"}
<script>
	$(function(){
		//tab初始化和数据存储
		var ntc = $('.notices');
		var co = getCookie("type");
		if(co == 11 || co == 12 || co == 13){
			c = co - 10;
		}
		ntc.eq(c-1).siblings('.notices' ).addClass('hidden');
		ntc.eq(c-1).removeClass('hidden');
		//上拉加载
		var len = ntc.eq(c - 1).find('.party a').length;
		if (len >= 2) {
			$('.tip').text('上拉加载更多');
		}
		loadScroll(c);
		//tab切换
		$('.tabs>.tab ').on('click',function(){
			var ntc = $('.notices' );
			var eq = $(this ).index();
			$(this ).siblings('.tab' ).find('span' ).removeClass('active');
			$(this ).find('span' ).addClass('active');
			ntc.eq(eq ).siblings('.notices' ).addClass('hidden');
			ntc.eq(eq).removeClass('hidden');
			if(eq==0) {
				var len = ntc.eq(eq).find('.party a').length;
				if (len >= 5) {
					$('.tip').text('上拉加载更多');
				}
				loadScroll(eq + 1);
			}
			if(eq==1) {
				$(".tip").hide();
				$(".loading").hide();
			}
			//使用示例
			setCookie("type",eq+11);
		});
		//安卓4.4tab兼容
		var u = navigator.userAgent;
		var isAnd = !u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);
		if(isAnd){
			var num = u.substr(u.indexOf('Android') + 8, 3);
			if(num <= 4.4){
				var tabw = $('.tabs').width()/3 -2;
				$('.tabs>.tab').width(tabw);
			}
		}
	});

	function loadScroll(){
		$(window ).off("scroll" ).on("scroll",function(){
			var dh = $(document).height();
			var end = $(window).height() + $(window ).scrollTop();
			var len = $(".list" ).length;
			var tip = $(".tip");
			var loading = $('.loading');
			if(dh == end && scrollNow){
				scrollNow = false;//请求执行中
				$.ajax({
					type:"post",
					url:"{:Url('Company/moreList')}",
					data:{
						length:len
					},
					beforeSend: function(XMLHttpRequest){
						tip.hide();
						loading.toggleClass('hidden');
					},
					success:function(data){
						loading.toggleClass('hidden');
						tip.show();
						if(data.code == 1){
							addLists(data);
							var dataLen =data.data.length;
							if(data.data.length == 5){
								tip.text('上拉加载更多');
							}else{
								tip.text('没有更多了');
								$(window ).off("scroll");
							}
							scrollNow = true;//请求结束
						}
					}
				})
			}
		})
	}
	function addLists(data){
		var html = '';
		var lists = data.data;
		var len = lists.length;
		for(var i = 0; i< len;i++){
			var list = lists[i];
			html +=
					'<a href="/home/company/detail/id/'+ list.id+'.html" class="list">'+
						'<img src="'+ list.front_src +'" alt="封面图" class="cover">'+
							'<img src="'+ list.header_src +'" alt="头像" class="user">'+
							'<div class="title limit">'+ list.title +'</div>'+
					'</a>'
		}
		$(".lists" ).append(html);
	}
})
</script>
{/block}