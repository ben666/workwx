{extend name="public/common"}

{block name="style"}
<title>支部工作</title>
<link rel="stylesheet" href="/static/datepicker/bootstrap-datetimepicker.min.css">
<link rel="stylesheet" href="/home/css/special/notes.css">
<link rel="stylesheet" href="/static/sweetalert/sweetalert.css">
<!--<link rel="stylesheet" href="/static/framework7/framework7.ios.colors.min.css">-->
<!--<link rel="stylesheet" href="/static/framework7/framework7.ios.min.css">-->
<style>
	*{
		font-family: "Microsoft Yahei", "Helvetica Neue", Helvetica, Arial, sans-serif;
	}
    #text::-webkit-input-placeholder{
        text-indent:2em;
    }
    .loading {
        width:0;
        height:0;
        border-right:20px solid #fff;
        border-top:20px solid #000;
        border-left:20px solid #fff;
        border-bottom:20px solid #000;
        border-radius: 20px;
        -moz-border-radius: 20px;
        -webkit-border-radius: 20px;

        position:absolute;
        top:200px;
        left:calc(50% - 20px)
    }
    .loading {
        animation: bganim 0.9s linear 0s infinite;
        -moz-animation: bganim 0.9s linear 0s infinite;
        -webkit-animation: bganim 0.9s linear 0s infinite;
    }
    @keyframes bganim {
        from { transform:rotate(0deg); } to { transform:rotate(360deg); }
    }
    @-moz-keyframes bganim {
        from { -moz-transform:rotate(0deg); } to { -moz-transform:rotate(360deg); }
    }
    @-webkit-keyframes bganim {
        from { -webkit-transform:rotate(0deg); } to { -webkit-transform:rotate(360deg); }
    }
	.type2 {
		top: 80px;
		height: 280px;
		overflow: scroll;
	}
	.type2 li {
		width: 305px;
	}
</style>
{/block}

{block name="body"}

<div style="background:#000;opacity:0.8;height:150%;width:100%;position:absolute;top:0;left:0;display: none;z-index:1000" id="aaa">
    <div style="position:absolute;top:250px;left:calc(50% - 40px);width:100px;height:20px;line-height:20px;"><span style="color:#ddd;">图片上传中...</span></div>
</div>
<div id="bbb" style="display: none;z-index:1001">
    <img src="/home/images/notice/1.gif" alt="" style="position:absolute;top:200px;left:calc(50% - 20px)">

</div>
<div class="form">
	<div class="list">
		<span>发布栏</span>
		<div class="select" data-tab="">请选择发布栏目 <i class="fa fa-angle-down"></i></div>
	</div>
	<div class="list">
		<span>所属支部</span>
		<div class="select1" data-tab="">请选择所在支部 <i class="fa fa-angle-down"></i></div>
	</div>
	<div class="item-input list meeting" style="border-bottom: 1px solid #f1f1f1;">
		<span>会议时间</span>
		<!--<input type="text" placeholder="请输入日期..." name="date" readonly id="calendar-disabled" value="{$note.meet_time || default =''}">-->
		<input type="text" placeholder="请输入时间..." class="form-control datetimepicker form_title" name="meet_time" style="border:none;-webkit-box-shadow:none;box-shadow:none;-webkit-transition:none;transition:none;padding:0;width:80%;" value="">
	</div>
	<div class="list meeting">
		<span>会议地点</span>
		<input type="text" placeholder="请输入地点..." name="place" value="" style="width:80%;">
	</div>
	<div class="list title">
		<span>会议主题</span>
		<input type="text" placeholder="请输入主题..." name="title" value="" style="width:80%;">
	</div>
	<div class="list meeting">
		<span>会议人员</span>
		<input type="text" placeholder="请输入人员..." name="staff" value="" style="width:80%;">
	</div>


</div>
<div class="block">
	<textarea name="content" id="text" placeholder="请输入内容..." style="text-indent:2em;"></textarea>
	<div class="imgs clear" style="position:relative;">
		<div class="img fl hide"></div>
		<div class="img fl hide"></div>
		<div class="img fl hide"></div>
		<div class="img fl hide"></div>
		<div class="add fl">
			+
		</div>
		<input type="file" class="hide" id="upimg" accept="image/jpg, image/png, image/gif, image/jpeg">
        <span style="position:absolute;bottom:0;right:3.5%;;color:#cdcdcd;font-size:12px;" id="hehe" >（您最多上传四张图片）</span>
		<input type="hidden" name="header"  value="" required="">
	</div>
</div>
<input type="hidden" name="id" value="{$note.id || default=''}">
<div class="foot">
	<div class="save">提&emsp;交</div>
</div>
<!--摸态框-->
<div class="typebg"></div>
<ul class="type">
	<li>三会一课</li>
	<li>支部活动</li>
</ul>
<div class="tips">
</div>

<!--摸态框-->
<div class="typebg2"></div>
<ul class="type2">
	{volist name="info" id="io"}
	<li data-id="{$io.id}">{$io.name}</li>
	{/volist}
</ul>
<div class="tips">
</div>
{/block}
{block name="script"}
<!--<script src="/static/framework7/framework7.js"></script>-->
<!--时间日历-->
<script src="/static/datepicker/bootstrap-datetimepicker.js"></script>
<script src="/static/sweetalert/sweetalert.min.js"></script>
<script>

//alert优化
var wAlert = window.alert;
window.alert = function (message) {
    try {
        var iframe = document.createElement("IFRAME");
        iframe.style.display = "none";
        iframe.setAttribute("src", 'data:text/plain,');
        document.documentElement.appendChild(iframe);
        var alertFrame = window.frames[0];
        var iwindow = alertFrame.window;
        if (iwindow == undefined) {
            iwindow = alertFrame.contentWindow;
        }
        iwindow.alert(message);
        iframe.parentNode.removeChild(iframe);
    }
    catch (exc) {
        return wAlert(message);
    }
}
var wConfirm = window.confirm;
window.confirm = function (message) {
    try {
        var iframe = document.createElement("IFRAME");
        iframe.style.display = "none";
        iframe.setAttribute("src", 'data:text/plain,');
        document.documentElement.appendChild(iframe);
        var alertFrame = window.frames[0];
        var iwindow = alertFrame.window;
        if (iwindow == undefined) {
            iwindow = alertFrame.contentWindow;
        }
        iwindow.confirm(message);
        iframe.parentNode.removeChild(iframe);
    }
    catch (exc) {
        return wConfirm(message);
    }
};


$(function(){
	//    时间日历
	$( ".datetimepicker" ).datetimepicker( {
		language:  'cn',
		format: 'yyyy-mm-dd hh:ii',
		forceParse: false,
		todayBtn: true,
		autoclose: true,
		todayHighlight: 1,
		minuteStep: 5

	});

	//模块标题
	$('title').text('支部活动');
	//初始发布栏
	var sel = $('.select');
	var text;
	var value = sel.attr('data-tab');
	if(value != '' ){
		if(value == 1) {
			text = "三会一课"
		}else if(value == 2 ){
			text = '支部活动'
		}
		selchange(text,value);
	}
	//初始图片
	var imglen = 0;
	var src1 = $('.img_:nth-child(1) img' ).attr('src');
	var src2 = $('.img_:nth-child(2) img' ).attr('src');
	if(src1 != undefined){
		if(src1 == ''){
			$('.img_').remove();
		}else if(src1 != '' && src2 == undefined){
			$('.img_:nth-child(2)' ).remove();
			imglen = 1;
		}else {
			$('.add' ).hide();
		}
	}
	imgresize();
	//发布栏选择
	sel.on('click',function(){
		$('.typebg' ).fadeIn();
		$('.type' ).fadeIn();
		$('.type li' ).on('click',function(){
			var value = $(this ).index()+1;
			if(value == 1){
				$(".meeting").show();
				$(".title span").html("会议主题")
				$('.select').attr('data-tab',value);
			}else if(value == 2){
				$(".title span").html("活动主题")
				$('.select').attr('data-tab',value);
				$(".meeting").hide()
			}
			var text = $(this ).text();
			selchange(text,value);
		})
	});

	$(".select1").on('click',function(){
		$('.typebg2' ).fadeIn();
		$('.type2' ).fadeIn();
		$('.type2 li' ).on('click',function(){
			var id = $(this).data("id")
				$('.select1').attr('data-tab',id)
			var text = $(this ).text();
			selchange2(text,id);
		})
	});
	//摸态框退出
	$('.typebg,.tips' ).on('click',modalclear);
	$('.typebg2,.tips' ).on('click',modalclear2);
	//图片上传
	$('.add,.img' ).on('click',function(){
		var this_ = $(this );
		$('#upimg').click().off("change").on('change',function(){
			var size = ($(this)[0].files[0].size / 1024).toFixed(2);
			if(size <= 10240){
				var img = $(this)[0].files[0];
				var formData = new FormData();
				formData.append("picture",img);
				if($('.img').attr('src')!=''){
					$('#hehe').fadeOut()
				}
				$.ajax({
					type:"post",
					url:"{:Url('File/uploadPicture')}",
					data:formData,
					processData : false,
					contentType : false,
                    beforeSend:function(){
                       $('#aaa').fadeIn();
                        $('#bbb').fadeIn();
                    },
					success:function(data){
                        $('#aaa').fadeOut();
                        $('#bbb').fadeOut();
						var msg = $.parseJSON(data);
                        console.log(msg);
						if(msg.code == 1){
							if(this_.hasClass('add')){
								//图片添加
								if(imglen == 0){
									$('.img').eq(0).removeClass('hide' ).append('<img src='+msg.data.path+' alt="笔记图片">');
									imglen = 1;
								}else if(imglen == 1){
									$('.img').eq(1).removeClass('hide').append('<img src='+msg.data.path+' alt="笔记图片">');
									imglen = 2;
								}else if(imglen == 2){
									$('.img').eq(2).removeClass('hide').append('<img src='+msg.data.path+' alt="笔记图片">');
									imglen = 3;
								}else if(imglen == 3){
									$('.img').eq(3).removeClass('hide').append('<img src='+msg.data.path+' alt="笔记图片">');
									$('.add').fadeOut();
								}
								imgresize();
							}else{
								//图片修改
								this_.find('img').remove();
								this_.append('<img src='+msg.data.path+' alt="笔记图片">');
								imgresize();
							}


						} else {
                            alert('上传失败');
							//warning({msg:'上传失败'});
							return;
						}
					}
				});
			} else {
				//warning({msg:"您选择的图片超过2mb，请重新选择"});
                alert('您选择的图片超过10mb，请重新选择');
				return;
			}
		});
	});
	//保存
	$('.save').on('click',function(){
		if($(".select div").html()=="三会一课") {
			data= {
				type: $(".select").attr('data-tab'),
				title: $("input[name='title']").val(),
				content: $("textarea[name='content']").val(),
				meet_home: $("input[name='place']").val(),
				branch: $(".select1").attr('data-tab'),
				staff: $("input[name='staff']").val(),
				meet_time: $("input[name='meet_time']").val(),
			};
		}else{
			data= {
				type: $(".select").attr('data-tab'),
				title: $("input[name='title']").val(),
				content: $("textarea[name='content']").val(),
				branch: $(".select1").attr('data-tab'),
			};
		}
		var single = false;
		for(var key in data){
			if(data[key]!= ''){
				single = true;
				break;
			}
		}
		if($('.img:nth-child(1) img').attr('src')!= undefined){

		}
		if($(".select div").html()=="三会一课") {
			if (!data.type || !data.title || !data.content || !data.meet_home || !data.branch || !data.staff || !data.meet_time) {
				swal("", "请填写完整信息", "warning");
				return;
			}
		}
		if($(".select div").html()=="支部活动") {
			if (!data.type || !data.title || !data.content || !data.branch) {
				swal("", "请填写完整信息", "warning");
				return;
			}
		}
			if(single){
				data['images'] = [$('.img:nth-child(1) img').attr('src'),$('.img:nth-child(2) img').attr('src'),$('.img:nth-child(3) img').attr('src'),$('.img:nth-child(4) img').attr('src')];
				$.ajax({
					type:"post",
					url: "{:Url('Vote/notes')}",
					data:data,
					success:function(data){
						$('.typebg' ).fadeIn();
						swal("恭喜您", "提交成功", "success");
						$('.typebg,.tips').off('click');
						setTimeout(function(){
							window.history.go(-1);
						},1500)
					},
					error: function(XMLHttpRequest, textStatus, errorThrown) {
//						alert(XMLHttpRequest.status);
//						alert(XMLHttpRequest.readyState);
//						alert(textStatus);
					}
				});
			}else{
				window.scrollTo(0,0);
				$('.typebg' ).fadeIn();
				swal("", "请填写完整信息", "warning");
				setTimeout(function(){
					modalclear();
					$('.tips' ).text('');
				},500)
			}
	});

});
function selchange(text,value){
	modalclear();
	$('.select').html('<div style="color:#999999">'+text+'</div>')
}
function selchange2(text,id){
	modalclear2();
	$('.select1').html('<div style="color:#999999">'+text+'</div>')
}
function modalclear(){
	$('.typebg,.type,.tips,.tocheck' ).fadeOut();
	setTimeout(function(){
		$('.yes').on('click');
	},1000)
}
function modalclear2(){
	$('.typebg2,.type2,.tips,.tocheck' ).fadeOut();
	setTimeout(function(){
		$('.yes').on('click');
	},1000)
}
function imgresize(){
	setTimeout(function(){
		var img = $('.img img' );
		img.each(function(){
			if($(this).width() == $(this).height()){
				$(this).height('78px');
				$(this).width('78px');
			}else if($(this).width() > $(this).height()){
				$(this).height('78px' ).css({'left':-$(this).width()/2+78/2});
			}else{
				$(this).width('78px').css({'top':-$(this).height()/2+78/2});
			}
		});
	},100);
}
</script>
{/block}