{extend name="public/common"}

{block name="style"}
<link rel="stylesheet" href="/home/css/notice/notice.css">
<style>
	.tabs .tab {
		width: 49vw;
	}
</style>
{/block}

{block name="body"}
<!--banner-->
<div class="banner swiper-container">
	<img src="/home/images/notice/5.jpg" alt="支部活动banner" class="banner-img">
</div>
<div class="tabs clear">
	<div class="tab"><span>三会一课</span></div>
	<div class="tab"><span>组织活动</span></div>
</div>
<!--切换列表-->
<div class="content">
	<!--三会一课：三个模块（相关通知、会议情况、党课情况）-->
	<div class="notices hidden">
		<!--相关通知-->
		<div class="notice">
			<a href="{:Url('Notice/relevantlist?type=1')}" class="tab clear">
				<span class="fl">相关通知</span>
				<span class="fr">更多</span>
			</a>
			{volist name="relevant" id="re"}
			<a href="{:Url('Notice/recruit?id='.$re['id'])}" class="list">
				<div class="title limit">{$re['title']}</div>
				<div class="content limit_">{$re['description']}</div>
				<div class="clear time">
					<span class="fl">{$re['create_time']|time_format="Y-m-d"}</span>
					<span class="fr fa fa-angle-right"></span>
				</div>
			</a>
			{/volist}
		</div>
		<!--情况报道-->
		<div class="notice party">
			<div class="tab clear" >
				<span class="fl">情况报道</span>
			</div>
			{volist name="meet" id="pa"}
			<a href="{:Url('Notice/activity?id='.$pa['id'])}" class="list clear">
				<div class="fl">
					<img src="{$pa['front_cover']|get_cover='path'}" alt="图片">
				</div>
				<div class="fr right">
					<div class="title limit_">{$pa['title']}</div>
					<div class="clear time">
						<span class="fl">{$pa['create_time']|time_format="Y-m-d"}</span>
						<span class="fr fa fa-angle-right"></span>
					</div>
				</div>
			</a>
			{/volist}
		</div>
	</div>
	<!--组织活动：两个模块（活动通知、活动情况）-->
	<div class="notices hidden">
		<!--活动通知-->
		<div class="notice">
			<a href="{:Url('Notice/relevantlist?type=3')}" class="tab clear" >
				<span class="fl">活动通知</span>
				<span class="fr">更多</span>
			</a>
			{volist name="recruit" id="rec"}
			<a href="{:Url('Notice/recruit?id='.$rec['id'])}" class="list">
				<div class="title limit">{$rec['title']} </div>
				<div class="content limit_">{$rec['description']}</div>
				<div class="clear time">
					<span class="fl">{$rec['create_time']|time_format="Y-m-d"}</span>
					<span class="fr fa fa-angle-right"></span>
				</div>
			</a>
			{/volist}
		</div>
		<!--活动情况-->
		<div class="notice activity">
			<div class="tab clear" >
				<span class="fl">活动情况</span>
			</div>
			{volist name="activity" id="ac"}
			<a href="{:Url('Notice/activity?id='.$ac['id'])}" class="list clear">
				<div class="fl">
					<img src="{$ac['front_cover']|get_cover='path'}" alt="图片">
				</div>
				<div class="fr right">
					<div class="title limit_">{$ac['title']}</div>
					<div class="clear time">
						<span class="fl">{$ac['create_time']|time_format="Y-m-d"}</span>
						<span class="fr fa fa-angle-right"></span>
					</div>
				</div>
			</a>
			{/volist}
		</div>
	</div>
</div>
<!--加载更多-->
<div class="tip"></div>
<div class="loading hidden">
	<div class="typing_loader"></div>
</div>
{/block}

{block name="script"}
<script>
	var scrollNow = true;//判断下拉请求是否执行中.false为正在请求
$(function(){
	//模块标题
	$('title').text('支部活动');
	//tab初始化和数据存储
	var ntc = $('.notices');
	var c =  parseInt(window.location.href.split("index/c/")[1]);
	var co = getCookie("type");
	if(co == 11 || co == 12 || co == 13){
		c = co - 10;
	}
	$('.tabs>.tab').eq(c-1).find('span').addClass('active');
	ntc.eq(c-1).removeClass('hidden');
	 //上拉加载
	var len = ntc.eq(c-1 ).find('.notice:last .list').length;
	if(len >= 5){
		$('.tip' ).text('上拉加载更多');
	}
	loadScroll(c);
	//tab切换
	$('.tabs>.tab ').on('click',function(){
		var ntc = $('.notices' );
		var eq = $(this ).index();
		$(this ).siblings('.tab' ).find('span' ).removeClass('active');
		$(this ).find('span' ).addClass('active');
		ntc.eq(eq ).siblings('.notices' ).addClass('hidden');
		ntc.eq(eq).removeClass('hidden');
		var len = ntc.eq(eq ).find('.notice:last .list').length;
		if(len >= 5){
			$('.tip' ).text('上拉加载更多');
			loadScroll(eq+1);
		}else{
			$('.tip').hide();
			$(window ).off("scroll" );

		}

		//使用示例
		setCookie("type",eq+11);
	});
	//安卓4.4tab兼容
	var u = navigator.userAgent;
	var isAnd = !u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);
	if(isAnd){
		var num = u.substr(u.indexOf('Android') + 8, 3);
		if(num <= 4.4){
			var tabw = $('.tabs').width()/3 -2;
			$('.tabs>.tab').width(tabw);
		}
	}
	isOut();
	//列表页：ue图片过滤
	$('.limit_ img' ).replaceWith('[图片]');
	$('.limit_ hr' ).replaceWith('');
	//悬浮框点击
	var show = true;
	$('.manager').off('click').on('click',function(){
		var this_ = $(this);
		this_.fadeOut();
		setTimeout(function(){
			if(show){
				this_.removeClass('manager' ).addClass('manager_').fadeIn();
				show = false;
			}else{
				this_.removeClass('manager_' ).addClass('manager').fadeIn();
				show = true;
			}

		},500)
	});
});
function loadScroll(type){
	$(window ).off("scroll" ).on("scroll",function(){
		var ntc = $('.notices');
		var dh = $(document).height();
		var end = $(window).height() + $(window ).scrollTop();
		var len = ntc.eq(type-1).find('.notice:last .list').length;
		var tip = $(".tip");
		var loading = $('.loading');
		if(dh == end && scrollNow){
			scrollNow = false;//请求执行中
			$.ajax({
				type:"post",
				url: "{:Url('Notice/activitymore')}",
				data:{
					length:len,
					type:type
				},
				beforeSend: function(XMLHttpRequest){
					tip.hide();
					loading.toggleClass('hidden');
				},
				success:function(data){
					loading.toggleClass('hidden');
					tip.show();
					if(data.code == 1){
						addLists(data,type);
						var dataLen =data.data.length;
						if(data.data.length == 5){
							tip.text('上拉加载更多');
						}
					}else{
						tip.text('没有更多了');
						$(window ).off("scroll");
					}
					scrollNow = true;//请求结束
				}
			})
		}
	})
}
function addLists(data,t){
	var type;
	var html = '';
	var lists = data.data;
	var len = lists.length;
	if ( t == 1){
		type = 'party'
	}else if( t == 2){
		type = 'activity';
	}else{
		type = 'situation';
	}

	for(var i = 0; i< len;i++){
		var list = lists[i];
		html +=
				'<a href="/home/notice/activity/id/'+ list.id+'.html" class="list clear">'+
				'<div class="fl">'+
				'<img src="'+list.path+'" alt="图片">'+
				'</div>'+
				'<div class="fr right">'+
				'<div class="title limit_">'+list.title+'</div>'+
				'<div class="clear time">'+
				'<span class="fl">'+list.time+'</span>'+
				'<span class="fr fa fa-angle-right"></span>'+
				'</div>'+
				'</div>'+
				'</a>'
	}
	$('.'+type).append(html);
}

//退出清理tab缓存
function isOut(){
	pushHistory();
	setTimeout(function(){
		window.addEventListener("popstate", function(e) {
				delCookie("type");
				window.history.go(-1);
		}, false);
	},200)
}
//防止恶意刷新
function pushHistory(){
	var sta = {
		title: "title"
	};
	if( window.history.state === null )
	{
		window.history.pushState( sta, "title" );
	}
}
function setCookie(name,value){
	var Days = 30;
	var exp = new Date();
	exp.setTime(exp.getTime() + Days*24*60*60*1000);
	document.cookie = name + "="+ value + ";expires=" + exp.toGMTString();
}
function getCookie(name){
	var arr,reg=new RegExp("(^| )"+name+"=([^;]*)(;|$)");
	if(arr=document.cookie.match(reg))
		return arr[2];
	else
		return null;
}
function delCookie(name){
	var exp = new Date();
	exp.setTime(exp.getTime() - 1);
	var cval=getCookie(name);
	if(cval!=null)
		document.cookie= name + "="+cval+";expires="+exp.toGMTString();
}
</script>
{/block}