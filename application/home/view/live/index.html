{extend name="public/common"}

{block name="style"}
<title>党建直播</title>
<link rel="stylesheet" href="/home/css/news/detail.css">
<style>
    .scrollDiy{
        position: absolute;
        top:50vw;
        bottom:0;
        overflow-y: scroll;
        /* 增加该属性，可以增加弹性 */
        -webkit-overflow-scrolling: touch;
        width:100%;
    }
    video{
        width:100vw;
        /*display:none;*/
        height:50vw;
    }
    .tabs {
        width: 100vw;
        height: 44px;
        padding: 8px 0;
        background: #f1f1f1;
        position: fixed;
        z-index: 99;
    }
    .tabs .tab {
        display: inline-block;
        width:49vw;
        height: 100%;
        color: #333333;
        font-size: 1.5rem;
        line-height: 28px;
        text-align: center;
    }
    .tabs .active {
        color: #fd6743;
    }
    .notice{
        margin-top: 44px;
    }
    .area{
        padding: 3vw 4vw;
        padding-left: 6vw;
    }
    .area div{
        display: inline-block;
        width: 44vw;
        text-align: left;
    }
    .area div span:first-child{
        width: 20vw;
        display: inline-block;
    }



    #videoBox {
        position: relative;
        height: 50vw;
    }

    #playBtn {
        position: absolute;
        left: 0;
        top: 0;
        display: block;
        border: none;
        background: url("/home/images/live/playBtn.png") center no-repeat;
        z-index: 1000;
        width: 100%;
        background-size: 100px;
        height: 50vw;
    }

    #poster {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        z-index: 100;
        height: 50vw;
    }

</style>

{/block}
<!--css一处 scrollDiy标签一对 tofixed()注释  scrollNow 跟scrollDiy滚动绑定-->
{block name="body"}
<!--<video src="{$live_path}" controls="controls" webkit-playsinline="true" playsinline></video>-->
<div id="videoBox">
    <!--<video id="videoBox" controls preload="auto" poster="images/tempPoster.jpg" x5-video-player-type="h5" x5-video-player-fullscreen="true">-->
    <video id="videoLive" preload="auto" poster=""  x5-video-player-type="h5" x5-video-player-fullscreen="true" webkit-playsinline="true" x-webkit-airplay="true" playsinline="true">
        <!--<source src="http://221.208.196.19:8080/hls/stream1.m3u8" type="application/x-mpegURL">-->
        <source src="{$live_path}">
    </video>
    <input id="playBtn" type="button" value="">
    <img id="poster" src="/home/images/live/player.png" alt="">
</div>
<div class="scrollDiy">
    <div class="tabs">
        <span class="tab active">聊天</span>
        <span class="tab">人数</span>
    </div>
    <div class="notice">
        <div class="comment">
        <div class="lists">
        </div>
        </div>
    </div>
    <div class="notice area">

    </div>
        <div class="tip"></div>
        <div class="loading hidden">
            <div class="typing_loader"></div>
        </div>
    </div>
</div>
{eq name="visit" value="0"}
<div class="bottom clear">
    <div class="myword fl">
        <input type="text" placeholder="说说你的感想！" onclick="tosend(this,12,1)">
    </div>
</div>
{/eq}

{/block}

{block name="script"}
<script src="/home/js/reset.js"></script>
<script>
    var iWindowWidth;
    var iWindowHeight;
    window.onresize = function () {
        autoWH();
        myPlayer.style.width = iWindowWidth + "px";
        myPlayer.style.height = iWindowHeight + "px";
    }
    //获取videojs生成的video
    var myPlayer = document.getElementById("videoLive");
    //播放按钮
    var oPlayBtn = document.getElementById("playBtn");
    //获取视频盒子
    var oVideoBox = document.getElementById("videoBox");
    //获取滚动盒子
    var oScrollBox = document.getElementById("scrollBox");
    //遮罩图片
    var oPoster = document.getElementById("poster");
    //图片加载完
    oPoster.onload = function () {
        oVideoBox.style.height = oPoster.offsetHeight + "px";
    }
//    window.addEventListener('touchmove', function (e) {
//        e.preventDefault();
//    }, false);
    function autoWH() {
        //获取可视区宽度
        iWindowWidth = $(window).width();
        //获取可视区高度
        iWindowHeight = $(window).height();
    }
    autoWH();

    //播放按钮呗点击
    oPlayBtn.onclick = function () {
        myPlayer.play();
        this.style.display = oPoster.style.display = "none";
    };

    //监听播放
    myPlayer.addEventListener('play', function () {
//        alert("播放");

    }, false);
    //监听暂停
    myPlayer.addEventListener('pause', function () {
//        alert("暂停");
    }, false);
    //监听结束
    myPlayer.addEventListener('ended', function () {
//        alert("结束");
    }, false);
</script>
<script>

    var scrollNow = true;//判断下拉请求是否执行中.false为正在请求
    $(function(){
        //初始化数据
        var ntc = $(".notice");
        var tab = $(".tabs .tab");
        var co = getCookie("type") || 0;
        co = parseInt(co);
        tab.eq(co).addClass("active").siblings(".tab").removeClass("active");
        ntc.eq(co).removeClass("hidden").siblings(".notice").addClass("hidden");
        if(co==0){
            chat();
            setInterval(chat,1500);
            $(".bottom").show();
        }else if(co==1){
            people();
            setInterval(people,1500);
            $(".bottom").hide();
        }

        //tab切换
        $(".tabs").on('click','.tab',function () {
            var ntc = $(".notice");
            var index = $(this).index();
            $(this).addClass("active").siblings(".tab").removeClass("active");
            $(".notice").eq(index).removeClass("hidden").siblings(".notice").addClass("hidden");
            if(index==0){
                chat();
                setInterval(chat,2000);
                $(".bottom").show();
            }else if(index==1){
                people();
                setInterval(people,2000);
                $(".bottom").hide();
            }
            //使用示例
            setCookie("type",index);
        })


    });
    /**
     * 点赞
     * @param e
     */
    var isGood = function(e,type,id){
        //样式变化，移到suc
        var n = $(e ).text();
        $(e).toggleClass('good' ).toggleClass('good_');
        $(e ).hasClass('good')?n--:n++;
        $(e ).text(n);
        $.ajax({
            type:"post",
            url:"{:Url('Base/like')}",
            data:{
                type:type,
                aid:id,
            },
            success:function(data){

            }
        })
    };
    /**
     * 发送评论
     * @param e
     */

    //发送评论
    var tosend = function(e,type,id){
        var index = $(e).parents('.votes ul li' ).index();
        setTimeout(function(){
            $("input").focus();
        },0)
        swal({
                    title: "",
                    text: "请输入评论内容！",
                    type: "input",
                    showCancelButton: true,
                    animation: "slide-from-top",
                    inputPlaceholder: "请在此输入评论内容（300字以内）",
                    confirmButtonText: "确定",
                    cancelButtonText: "取消",
                    closeOnConfirm: false
                },
                function(inputValue){
                    if (inputValue === false) {
                        $(".bottom").show();
                        setTimeout(function(){
                            $("input").blur();
                        },0)
                        return false
                    }else if (inputValue === "" || inputValue.length<5)
                    {
                        swal.showInputError("评论不少于5个字");
                        return false
                    }else if(inputValue.length>300){
                        swal.showInputError("评论不得多于300字");
                    }else{
                        $.ajax({
                            type:"post",
                            url:"{:Url('Base/comment')}",
                            data:{
                                type : type,
                                aid:id,
                                content:inputValue
                            },
                            success:function(msg){
                                inputValue="";
                                swal({
                                    title: ' ',
                                    text: '评论成功',
                                    type: 'success',
                                    confirmButtonText:'确定',
                                    timer:3000
                                });
                            }
                        });
                    }
                    setTimeout(function(){
                        $("input").blur();
                    },0)
                });
    };

//聊天评论
    var chat = function() {
        if ($(".list").length == 0) {
            var id = 0;
        } else {
            var id = $(".list:first").attr('data-id');
        }
        $.ajax({
            type: "post",
            url: "{:Url('Live/getComment')}",
            data: {
                id: id
            },
            beforeSend: function (XMLHttpRequest) {

            },
            success: function (data) {

                if (data.code == 1) {

                    addComment(data);
                }
            }
        })
    }


    function addComment(data){
        //is_like : 1为已点赞 0为未点赞
        var html = '';
        var lists = data.data;
        var len = lists.length;
        for(var i = 0; i< len;i++){
            var list = lists[i];
            var userid = "'"+list.create_user+"'";
            html += '<div class="list clear" data-id="'+list['id']+'">'+
                    '<div class="fl">'+
                    '<img src="'+list.header+'" alt="用户" class="user">'+
                    '</div>'+
                    '<div class="fl mid">'+
                    '<div class="name limit">'+ list.nickname+'</div>'+
                    '<div class="content" >'+ list.content+'</div>'+
                    '<div class="time">'+ list.time+'</div>'+
                    '</div>';
            html+=
                    '</div>';
        }
        $(".lists" ).prepend(html);
    }

    //观看人数
    var people = function() {
        $.ajax({
            type: "post",
            url: "{:Url('Live/getDepartmentNumer')}",
            data: {
            },
            beforeSend: function (XMLHttpRequest) {

            },
            success: function (data) {
console.log(data)
                if (data.code == 1) {
                    number(data);
                }
            }
        })
    }


    function number(data){
        console.log(data)
        //is_like : 1为已点赞 0为未点赞
        var html = '';
        var lists = data.data;
        var len = lists.length;
        for(var i = 0; i< len;i++){
            var list = lists[i];
            if(list.name.substr(0, 2)!=="之图"){
                html +=
                        '<div class="area">'
                                if(list.name=="开发区党支部"){
                                    html+=  '<span>'+ list.name.substr(0, 3)+'&nbsp;&nbsp;&nbsp;&nbsp;</span>'
                                }else {
                                    html+=  '<span>'+ list.name.substr(0, 2)+'&nbsp;&nbsp;&nbsp;&nbsp;</span>'
                                }

                       html+= '<span>'+ list.numer+'人</span>'+
                        '</div>';
            }
            }

       $(".area" ).html(html);
    }

    var u = navigator.userAgent;
    var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Adr') > -1; //android终端
    var isiOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端
    if (isiOS) {
        $('video source').css({
            'object-position': ' 0px 0px',
            'width': '100%',
            'height': '50vw'
        });
    } else {
        $('video').css({
            'object-position': ' 0px 0px',
            'width': '100%'
        });
    }
</script>
{/block}