{extend name="public/common"}

{block name="style"}
<link rel="stylesheet" href="/home/css/user/user.css">
<style>
	.sign,.change,.over{
		position: absolute;
		top:3vw;
		right:0;
		width: 18vw;
		height: 8vw;
		-webkit-border-radius:4vw 0 0 4vw ;
		border-radius:4vw 0 0 4vw ;
		line-height: 8vw;
		text-align: center;
		color: #ffffff;
		background: -webkit-linear-gradient(left, #ff8548, #fd5a0a);
		background: linear-gradient(left, #ff8548, #fd5a0a);
	}
	.over{
		width: 22vw;
	}
	.change{
		width: 22vw;
		animation: sign 0.5s ;
		-webkit-animation: sign 0.5s ;
	}
	@keyframes sign
	{
		0%{
			width: 18vw;
		}
		25%{
			width: 19vw;
		}
		50%{
			width: 20vw;
		}
		75%{
			width: 21vw;
		}
		100% {
			width: 22vw;
		}
	}

	@-webkit-keyframes sign /* Safari 和 Chrome */
	{
		0%{
			width: 18vw;
		}
		25%{
			width: 19vw;
		}
		50%{
			width: 20vw;
		}
		75%{
			width: 21vw;
		}
		100% {
			width: 22vw;
		}
	}

</style>
{/block}

{block name="body"}
{eq name="visit" value="1"}
<div class="banner">
	<img src="/home/images/user/vistor.jpg" alt="个人头像" class="up">
	<div class="name">游客</div>
</div>
{else/}
<div class="banner">
	{eq name="user.header" value=""}
	<div class="up" data-tab="{$user.avatar}"></div>
	{else/}
	<div class="up" data-tab="{$user.header}"></div>
	{/eq}
	<!--未签-->
	{eq name="is_sign" value="0"}
	<div class="sign">签到</div>
	{else/}
	<div class="over">已签 +{$is_sign}</div>
	{/eq}
	<div class="name">{$user.name}</div>
	<input type="file" class="hide" id="upload" accept="image/jpg, image/png, image/gif, image/jpeg">
	<input type="hidden" name="header"  value="" required="">
</div>
<div class="lists">
	<a href="{:Url('User/personal')}" class="list clear">
		<span>党员ID</span>
		<i class="fa fa-angle-right fr"></i>
	</a>
	<!--<a href="{:Url('User/history')}" class="list clear">-->
		<!--<span>我的消息</span>-->
		<!--<i class="fa fa-angle-right fr"></i>-->
	<!--</a>-->
	<a href="{:Url('Rank/personal')}" class="list clear">
		<span>个人排行榜</span>
		<i class="fa fa-angle-right fr"></i>
	</a>
	<a href="{:Url('Rank/department')}" class="list clear">
		<span>支部排行榜</span>
		<i class="fa fa-angle-right fr"></i>
	</a>
	<!--<a href="{:Url('Exchange/index')}" class="list clear">-->
		<!--<span>积分商城</span>-->
		<!--<i class="fa fa-angle-right fr"></i>-->
	<!--</a>-->
	<a href="{:Url('User/feedback')}" class="list clear">
		<span>意见反馈</span>
		<i class="fa fa-angle-right fr"></i>
	</a>
</div>
{/eq}
{/block}

{block name="script"}
<script>
$(function(){
	//模块标题
	$('title' ).text('个人中心');
	//头像大小
	var up = $('.up' );
	var path = up.attr('data-tab');
	var image = new Image();
	var ww = up.width();
	image.src = path ;
	up.css({"background-image":'url('+path+')'});
	image.onload = function(){
		if(image.width > image.height){
			up.css({"background-size":'auto '+ww +'px'});
		}else{
			up.css({"background-size":ww +'px'+' auto '});
		}
	};
	//触发上传按钮
	up.off("click").on('click',function(){
		$('#upload').click();
	});

	//上传图片并获取信息
	$('#upload').off("change").on('change',function(){
		var size = ($(this)[0].files[0].size / 1024).toFixed(2);
		if(size <= 2048){
			var img = $(this)[0].files[0];
			var formData = new FormData();
			formData.append("picture",img);
			$.ajax({
				type:"post",
				url:"{:Url('File/uploadPicture')}",
				data:formData,
				processData : false,
				contentType : false,
				success:function(data){
					var msg = $.parseJSON(data);
					if(msg.code == 1){
						var image = new Image();
						image.src = msg.data.path ;
						up.css({"background-image":'url('+msg.data.path+')'});
						image.onload = function(){
							if(image.width > image.height){
								up.css({"background-size":'auto '+ww +'px'});
							}else{
								up.css({"background-size":ww +'px'+' auto '});
							}
						};
						$.ajax({
							type:"post",
							url:"{:Url('User/setHeader')}",
							data:{header:msg.data.path},
							dataType: "Json",
							success:function(){

							}
						})
					} else {
						warning({msg:'上传失败'});
						return;
					}
				}
			});
		} else {
			warning({msg:"您选择的图片超过2mb，请重新选择"});
			return;
		}
	});

	//签到
	$('.sign').click(function(){
		$.ajax({
			url: "{:Url('User/sign')}",
			type: 'get',
			success: function(data){
				if(data.code == 1){
					$('.sign').removeClass('sign').addClass('change' ).text('已签 +'+data.data);
				}else{
					swal({
						title: '签到失败',
						type: 'info',
						text: data.msg,
						timer:2000,
						confirmButtonText:'确定',
						confirmButtonColor:'#A5DC86'
					});
				}
			}
		});
	})
})
</script>
{/block}